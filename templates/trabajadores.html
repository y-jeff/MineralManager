<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trabajadores - Mineral Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function addCertification(containerId) {
            const container = document.getElementById(containerId);
            const template = `
                <div class="row mb-3 certification-entry">
                    <div class="col">
                        <select class="form-select" name="certificaciones[][id]" required>
                            {% for cert_option in certificaciones %}
                            <option value="{{ cert_option.id }}">{{ cert_option.nombre_capacitacion }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <input type="date" class="form-control" name="certificaciones[][fecha_inicio]" required>
                    </div>
                    <div class="col">
                        <input type="date" class="form-control" name="certificaciones[][fecha_fin]">
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-danger" onclick="this.closest('.certification-entry').remove()">Eliminar</button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', template);
        }
    </script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
            <a class="navbar-brand" href="/home">Mineral Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/home">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/trabajadores">Trabajadores</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="container mt-4">
        <h1>Gestión de Trabajadores</h1>
        <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWorkerModal">Agregar Trabajador</button>
            <a href="{% url 'descargar_informe_trabajadores' %}" class="btn btn-secondary">Descargar Informe</a>
        </div>

        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>RUT</th>
                    <th>Nombre</th>
                    <th>Puesto</th>
                    <th>Área</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for trabajador in trabajadores %}
                <tr>
                    <td>{{ trabajador.rut }}</td>
                    <td>{{ trabajador.nombre_trabajador }}</td>
                    <td>{{ trabajador.cargo.nombre_cargo }}</td>
                    <td>{{ trabajador.area.nombre_area }}</td>
                    <td>
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal{{ trabajador.rut }}">Ver</button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ trabajador.rut }}">Eliminar</button>
                    </td>
                </tr>

                <!-- Modal Ver/Editar -->
                <div class="modal fade" id="viewModal{{ trabajador.rut }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form method="POST" action="?editar_id={{ trabajador.rut }}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title">Editar Trabajador</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="nombre" class="form-label">Nombre</label>
                                        <input type="text" name="nombre_trabajador" value="{{ trabajador.nombre_trabajador }}" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="puesto" class="form-label">Puesto</label>
                                        <select name="cargo" class="form-select">
                                            {% for cargo in cargos %}
                                            <option value="{{ cargo.id }}" {% if cargo.id == trabajador.cargo.id %}selected{% endif %}>{{ cargo.nombre_cargo }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="area" class="form-label">Área</label>
                                        <select name="area" class="form-select">
                                            {% for area in areas %}
                                            <option value="{{ area.id }}" {% if area.id == trabajador.area.id %}selected{% endif %}>{{ area.nombre_area }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <h6>Certificaciones:</h6>
                                        <div id="certificationContainer{{ trabajador.rut }}">
                                            {% for cert in trabajador.capacitaciontrabajador_set.all %}
                                            <div class="row mb-3 certification-entry">
                                                <div class="col">
                                                    <select class="form-select" name="certificaciones[{{ forloop.counter0 }}][id]" required>
                                                        {% for cert_option in certificaciones %}
                                                        <option value="{{ cert_option.id }}" {% if cert.capacitacion.id == cert_option.id %}selected{% endif %}>
                                                            {{ cert_option.nombre_capacitacion }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col">
                                                    <input type="date" name="certificaciones[{{ forloop.counter0 }}][fecha_inicio]" value="{{ cert.fecha_inicio }}" class="form-control" required>
                                                </div>
                                                <div class="col">
                                                    <input type="date" name="certificaciones[{{ forloop.counter0 }}][fecha_fin]" value="{{ cert.fecha_fin }}" class="form-control">
                                                </div>
                                                <div class="col">
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.certification-entry').remove()">Eliminar</button>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="addCertification('certificationContainer{{ trabajador.rut }}')">Agregar Certificación</button>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal Eliminar -->
                <div class="modal fade" id="deleteModal{{ trabajador.rut }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="POST" action="?eliminar_id={{ trabajador.rut }}">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirmar Eliminación</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ¿Está seguro que desea eliminar al trabajador {{ trabajador.nombre_trabajador }}?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>

        <!-- Modal Agregar -->
        <div class="modal fade" id="addWorkerModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form method="POST" action="?crear_trabajador=1">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">Agregar Trabajador</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="rut" class="form-label">RUT</label>
                                <input type="text" name="rut" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" name="nombre_trabajador" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="puesto" class="form-label">Puesto</label>
                                <select name="cargo" class="form-select" required>
                                    {% for cargo in cargos %}
                                    <option value="{{ cargo.id }}">{{ cargo.nombre_cargo }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="area" class="form-label">Área</label>
                                <select name="area" class="form-select" required>
                                    {% for area in areas %}
                                    <option value="{{ area.id }}">{{ area.nombre_area }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <h6>Certificaciones:</h6>
                                <div id="newCertificationContainer"></div>
                                <button type="button" class="btn btn-secondary" onclick="addCertification('newCertificationContainer')">Agregar Certificación</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-success">Agregar Trabajador</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</body>
</html>

